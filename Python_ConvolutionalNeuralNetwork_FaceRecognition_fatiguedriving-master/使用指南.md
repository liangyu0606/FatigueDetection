# 疲劳检测系统 - 公开数据集训练指南

## 🚀 快速开始

### 1. 安装依赖

```bash
# 安装基础依赖
pip install opencv-python numpy scikit-learn

# 安装深度学习依赖（用于CNN功能）
pip install tensorflow
```

### 2. 下载公开数据集

推荐使用以下数据集：

#### 🥇 Drowsiness Detection Dataset (推荐)
- **来源**: Kaggle
- **链接**: https://www.kaggle.com/datasets/dheerajperumandla/drowsiness-dataset
- **包含**: 清醒、疲劳、打哈欠、闭眼状态
- **样本数**: ~2900张图像

#### 🥈 Driver Drowsiness Dataset
- **来源**: Kaggle  
- **链接**: https://www.kaggle.com/datasets/ismailnasri20/driver-drowsiness-dataset
- **包含**: 清醒、疲劳状态
- **样本数**: ~1000张图像

#### 🥉 MRL Eye Dataset
- **来源**: Kaggle
- **链接**: https://www.kaggle.com/datasets/kutaykutlu/drowsiness-detection
- **包含**: 睁眼、闭眼状态
- **样本数**: ~4000张图像

### 3. 数据集准备

1. 从Kaggle下载数据集
2. 解压到 `./public_datasets/raw/` 目录
3. 运行训练脚本

```bash
# 创建目录结构
mkdir -p public_datasets/raw

# 将下载的数据集解压到 public_datasets/raw/ 目录
```

### 4. 开始训练

```bash
# 运行训练脚本
python public_dataset_trainer.py
```

## 📁 目录结构

训练完成后的目录结构：

```
project/
├── public_datasets/
│   ├── raw/                    # 原始数据集
│   ├── drowsiness_detection/
│   │   ├── processed/          # 处理后的数据
│   │   ├── train/              # 训练集
│   │   ├── validation/         # 验证集
│   │   └── test/               # 测试集
├── model/
│   ├── fatigue_model_mobilenet.h5  # 训练好的模型
│   └── class_indices.json          # 类别映射
├── public_dataset_trainer.py       # 训练脚本
└── simple_cnn_detector.py         # 简化的检测器
```

## 🔧 集成到主程序

训练完成后，在您的 `main.py` 中集成CNN检测器：

```python
# 在main.py顶部添加导入
from simple_cnn_detector import CNNFatigueDetector

# 在MainUI类的__init__方法中初始化
def __init__(self):
    # ... 现有代码 ...
    
    # 初始化CNN检测器
    self.cnn_detector = CNNFatigueDetector('./model/fatigue_model_mobilenet.h5')
    
    # ... 现有代码 ...

# 在检测循环中使用CNN检测器
def _learning_face(self):
    # ... 现有代码 ...
    
    # 在人脸检测成功后添加CNN分析
    if len(faces) != 0:
        for k, d in enumerate(faces):
            # ... 现有的人脸检测代码 ...
            
            # 提取人脸区域
            face_img = im_rd[d.top():d.bottom(), d.left():d.right()]
            
            # 使用CNN进行疲劳检测
            if self.cnn_detector.is_available():
                cnn_result = self.cnn_detector.get_fatigue_analysis(face_img)
                if cnn_result:
                    # 将CNN结果与传统方法结合
                    if cnn_result['fatigue_detected']:
                        res[1] = cnn_result['fatigue_level']
                        print(f"CNN检测: {cnn_result['fatigue_level']} (置信度: {cnn_result['confidence']:.2f})")
            
            # ... 继续现有代码 ...
```

## 📊 训练参数说明

### 模型选择
- **MobileNetV2**: 轻量级，适合实时检测
- **ResNet50**: 高精度，计算量较大
- **VGG16**: 经典网络，稳定可靠

### 训练参数
- **epochs**: 30 (可根据数据集大小调整)
- **batch_size**: 32
- **学习率**: 0.001
- **数据增强**: 旋转、平移、亮度调整

## 🎯 性能优化建议

### 1. 数据质量
- 确保数据集标注准确
- 平衡各类别样本数量
- 包含不同光照条件的图像

### 2. 模型调优
- 根据实际使用场景调整阈值
- 使用交叉验证评估模型性能
- 考虑模型集成提高准确率

### 3. 实时性优化
- 使用MobileNet等轻量级模型
- 降低输入图像分辨率
- 使用GPU加速推理

## 🔍 故障排除

### 常见问题

1. **TensorFlow安装失败**
   ```bash
   # 使用conda安装
   conda install tensorflow
   
   # 或指定版本
   pip install tensorflow==2.10.0
   ```

2. **内存不足**
   - 减小batch_size
   - 使用更小的模型
   - 减少数据增强

3. **训练速度慢**
   - 使用GPU训练
   - 减少epochs数量
   - 使用预训练模型

4. **模型精度低**
   - 增加训练数据
   - 调整学习率
   - 使用更复杂的模型

## 📈 评估指标

训练完成后，系统会输出以下指标：

- **准确率 (Accuracy)**: 整体预测正确率
- **损失值 (Loss)**: 模型训练损失
- **验证准确率**: 验证集上的性能

## 🎉 完成后的效果

成功训练后，您的疲劳检测系统将具备：

1. **传统方法**: 眨眼、打哈欠、点头检测
2. **CNN方法**: 深度学习疲劳状态识别
3. **融合检测**: 两种方法结合，提高准确率
4. **实时分析**: 流畅的实时疲劳检测

## 📞 技术支持

如果遇到问题，请检查：

1. 数据集是否正确下载和解压
2. 依赖库是否正确安装
3. 目录结构是否正确
4. 模型文件是否成功生成

祝您训练成功！🎊
